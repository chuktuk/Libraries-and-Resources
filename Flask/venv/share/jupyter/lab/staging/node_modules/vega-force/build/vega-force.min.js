!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("d3-force")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-force"],t):t(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3)}(this,(function(e,t,a,r){"use strict";var n={center:r.forceCenter,collide:r.forceCollide,nbody:r.forceManyBody,link:r.forceLink,x:r.forceX,y:r.forceY},o=["alpha","alphaMin","alphaTarget","velocityDecay","forces"],i=["static","iterations"],f=["x","y","vx","vy"];function u(e){t.Transform.call(this,null,e)}u.Definition={type:"Force",metadata:{modifies:!0},params:[{name:"static",type:"boolean",default:!1},{name:"restart",type:"boolean",default:!1},{name:"iterations",type:"number",default:300},{name:"alpha",type:"number",default:1},{name:"alphaMin",type:"number",default:.001},{name:"alphaTarget",type:"number",default:0},{name:"velocityDecay",type:"number",default:.4},{name:"forces",type:"param",array:!0,params:[{key:{force:"center"},params:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0}]},{key:{force:"collide"},params:[{name:"radius",type:"number",expr:!0},{name:"strength",type:"number",default:.7},{name:"iterations",type:"number",default:1}]},{key:{force:"nbody"},params:[{name:"strength",type:"number",default:-30},{name:"theta",type:"number",default:.9},{name:"distanceMin",type:"number",default:1},{name:"distanceMax",type:"number"}]},{key:{force:"link"},params:[{name:"links",type:"data"},{name:"id",type:"field"},{name:"distance",type:"number",default:30,expr:!0},{name:"strength",type:"number",expr:!0},{name:"iterations",type:"number",default:1}]},{key:{force:"x"},params:[{name:"strength",type:"number",default:.1},{name:"x",type:"field"}]},{key:{force:"y"},params:[{name:"strength",type:"number",default:.1},{name:"y",type:"field"}]}]},{name:"as",type:"string",array:!0,modify:!1,default:f}]};var s=a.inherits(u,t.Transform);function c(e,t,r,n){var i,f,u,s,c=a.array(t.forces);for(i=0,f=o.length;i<f;++i)"forces"!==(u=o[i])&&t.modified(u)&&e[u](t[u]);for(i=0,f=c.length;i<f;++i)s="forces"+i,(u=r||t.modified("forces",i)?d(c[i]):n&&l(c[i],n)?e.force(s):null)&&e.force(s,u);for(f=e.numForces||0;i<f;++i)e.force("forces"+i,null);return e.numForces=c.length,e}function l(e,t){var r,n;for(r in e)if(a.isFunction(n=e[r])&&t.modified(a.accessorFields(n)))return 1;return 0}function d(e){var t,r;for(r in a.hasOwnProperty(n,e.force)||a.error("Unrecognized force: "+e.force),t=n[e.force](),e)a.isFunction(t[r])&&m(t[r],e[r],e);return t}function m(e,t,r){e(a.isFunction(t)?function(e){return t(e,r)}:t)}s.transform=function(e,t){var a,n,f=this.value,u=t.changed(t.ADD_REM),s=e.modified(o),l=e.iterations||300;if(f?(u&&(t.modifies("index"),f.nodes(t.source)),(s||t.changed(t.MOD))&&c(f,e,0,t)):(this.value=f=function(e,t){var a=r.forceSimulation(e),n=!1,o=a.stop,i=a.restart;return a.stopped=function(){return n},a.restart=function(){return n=!1,i()},a.stop=function(){return n=!0,o()},c(a,t,!0).on("end",(function(){n=!0}))}(t.source,e),f.on("tick",(a=t.dataflow,n=this,function(){a.touch(n).run()})),e.static||(u=!0,f.tick()),t.modifies("index")),s||u||e.modified(i)||t.changed()&&e.restart)if(f.alpha(Math.max(f.alpha(),e.alpha||1)).alphaDecay(1-Math.pow(f.alphaMin(),1/l)),e.static)for(f.stop();--l>=0;)f.tick();else if(f.stopped()&&f.restart(),!u)return t.StopPropagation;return this.finish(e,t)},s.finish=function(e,t){for(var a,r=t.dataflow,n=this._argops,o=0,i=n.length;o<i;++o)if("forces"===(a=n[o]).name&&"link"===a.op._argval.force)for(var u,s=a.op._argops,c=0,l=s.length;c<l;++c)if("links"===s[c].name&&(u=s[c].op.source)){r.pulse(u,r.changeset().reflow());break}return t.reflow(e.modified()).modifies(f)},e.force=u,Object.defineProperty(e,"__esModule",{value:!0})}));