!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3-array"),require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","d3-array","vega-dataflow","vega-util"],r):r(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.d3,e.vega,e.vega)}(this,(function(e,r,n,i){"use strict";function t(e){return new Uint8Array(e)}function a(e){return new Uint16Array(e)}function o(e){return new Uint32Array(e)}function f(e,r,n){var i=(r<257?t:r<65537?a:o)(e);return n&&i.set(n),i}function u(e,r,n){var i=1<<r;return{one:i,zero:~i,range:n.slice(),bisect:e.bisect,index:e.index,size:e.size,onAdd:function(e,r){var n,t=this.bisect(this.range,e.value),a=e.index,o=t[0],f=t[1],u=a.length;for(n=0;n<o;++n)r[a[n]]|=i;for(n=f;n<u;++n)r[a[n]]|=i;return this}}}function s(){var e=o(0),n=[],i=0;return{insert:function(t,a,f){if(!a.length)return[];var u,s,l,d=i,c=a.length,h=Array(c),m=o(c);for(l=0;l<c;++l)h[l]=t(a[l]),m[l]=l;if(h=function(e,n){return e.sort.call(n,(function(r,n){var i=e[r],t=e[n];return i<t?-1:i>t?1:0})),r.permute(e,n)}(h,m),d)u=n,s=e,n=Array(d+c),e=o(d+c),function(e,r,n,i,t,a,o,f,u){var s,l=0,d=0;for(s=0;l<i&&d<o;++s)r[l]<t[d]?(f[s]=r[l],u[s]=n[l++]):(f[s]=t[d],u[s]=a[d++]+e);for(;l<i;++l,++s)f[s]=r[l],u[s]=n[l];for(;d<o;++d,++s)f[s]=t[d],u[s]=a[d]+e}(f,u,s,d,h,m,c,n,e);else{if(f>0)for(l=0;l<c;++l)m[l]+=f;n=h,e=m}return i=d+c,{index:m,value:h}},remove:function(r,t){var a,o,f,u=i;for(o=0;!t[e[o]]&&o<u;++o);for(f=o;o<u;++o)t[a=e[o]]||(e[f]=a,n[f]=n[o],++f);i=u-r},bisect:function(e,t){var a;return t?a=t.length:(t=n,a=i),[r.bisectLeft(t,e[0],0,a),r.bisectRight(t,e[1],0,a)]},reindex:function(r){for(var n=0,t=i;n<t;++n)e[n]=r[e[n]]},index:function(){return e},size:function(){return i}}}function l(e){var r,i,t,a,u;n.Transform.call(this,(r=8,i=[],t=o(0),a=f(0,r),u=f(0,r),{data:function(){return i},seen:function(){return t=function(e,r,n){return e.length>=r?e:((n=n||new e.constructor(r)).set(e),n)}(t,i.length)},add:function(e){for(var r,n=0,t=i.length,a=e.length;n<a;++n)(r=e[n])._index=t++,i.push(r)},remove:function(e,r){var n,t,o,f=i.length,s=Array(f-e),l=i;for(t=0;!r[t]&&t<f;++t)s[t]=i[t],l[t]=t;for(o=t;t<f;++t)n=i[t],r[t]?l[t]=-1:(l[t]=o,a[o]=a[t],u[o]=u[t],s[o]=n,n._index=o++),a[t]=0;return i=s,l},size:function(){return i.length},curr:function(){return a},prev:function(){return u},reset:function(e){u[e]=a[e]},all:function(){return r<257?255:r<65537?65535:4294967295},set:function(e,r){a[e]|=r},clear:function(e,r){a[e]&=~r},resize:function(e,n){(e>a.length||n>r)&&(r=Math.max(n,r),a=f(e,r,a),u=f(e,r))}}),e),this._indices=null,this._dims=null}l.Definition={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"query",type:"array",array:!0,required:!0,content:{type:"number",array:!0,length:2}}]};var d=i.inherits(l,n.Transform);function c(e){n.Transform.call(this,null,e)}d.transform=function(e,r){return this._dims?e.modified("fields")||e.fields.some((function(e){return r.modified(e.fields)}))?this.reinit(e,r):this.eval(e,r):this.init(e,r)},d.init=function(e,r){for(var n,i,t=e.fields,a=e.query,o=this._indices={},f=this._dims=[],l=a.length,d=0;d<l;++d)i=o[n=t[d].fname]||(o[n]=s()),f.push(u(i,d,a[d]));return this.eval(e,r)},d.reinit=function(e,r){var n,i,t,a,o,f,l,d,c,h=r.materialize().fork(),m=e.fields,v=e.query,g=this._indices,p=this._dims,y=this.value,x=y.curr(),_=y.prev(),b=y.all(),A=h.rem=h.add,q=h.mod,M=v.length,z={};if(_.set(x),r.rem.length&&(o=this.remove(e,r,h)),r.add.length&&y.add(r.add),r.mod.length)for(f={},l=0,d=(a=r.mod).length;l<d;++l)f[a[l]._index]=1;for(l=0;l<M;++l)c=m[l],(!p[l]||e.modified("fields",l)||r.modified(c.fields))&&((n=z[t=c.fname])||(g[t]=i=s(),z[t]=n=i.insert(c,r.source,0)),p[l]=u(i,l,v[l]).onAdd(n,x));for(l=0,d=y.data().length;l<d;++l)o[l]||(_[l]!==x[l]?A.push(l):f[l]&&x[l]!==b&&q.push(l));return y.mask=(1<<M)-1,h},d.eval=function(e,r){var n=r.materialize().fork(),i=this._dims.length,t=0;return r.rem.length&&(this.remove(e,r,n),t|=(1<<i)-1),e.modified("query")&&!e.modified("fields")&&(t|=this.update(e,r,n)),r.add.length&&(this.insert(e,r,n),t|=(1<<i)-1),r.mod.length&&(this.modify(r,n),t|=(1<<i)-1),this.value.mask=t,n},d.insert=function(e,r,n){var i,t,a,o=r.add,f=this.value,u=this._dims,s=this._indices,l=e.fields,d={},c=n.add,h=f.size(),m=h+o.length,v=u.length;f.resize(m,v),f.add(o);var g=f.curr(),p=f.prev(),y=f.all();for(i=0;i<v;++i)a=d[t=l[i].fname]||(d[t]=s[t].insert(l[i],o,h)),u[i].onAdd(a,g);for(;h<m;++h)p[h]=y,g[h]!==y&&c.push(h)},d.modify=function(e,r){var n,i,t,a=r.mod,o=this.value,f=o.curr(),u=o.all(),s=e.mod;for(n=0,i=s.length;n<i;++n)f[t=s[n]._index]!==u&&a.push(t)},d.remove=function(e,r,n){var i,t,a,o,f=this._indices,u=this.value,s=u.curr(),l=u.prev(),d=u.all(),c={},h=n.rem,m=r.rem;for(i=0,t=m.length;i<t;++i)c[a=m[i]._index]=1,l[a]=o=s[a],s[a]=d,o!==d&&h.push(a);for(a in f)f[a].remove(t,c);return this.reindex(r,t,c),c},d.reindex=function(e,r,n){var i=this._indices,t=this.value;e.runAfter((function(){var e=t.remove(r,n);for(var a in i)i[a].reindex(e)}))},d.update=function(e,r,n){var i,t,a=this._dims,o=e.query,f=r.stamp,u=a.length,s=0;for(n.filters=0,t=0;t<u;++t)e.modified("query",t)&&(i=t,++s);if(1===s)s=a[i].one,this.incrementOne(a[i],o[i],n.add,n.rem);else for(t=0,s=0;t<u;++t)e.modified("query",t)&&(s|=a[t].one,this.incrementAll(a[t],o[t],f,n.add),n.rem=n.add);return s},d.incrementAll=function(e,r,n,i){var t,a,o,f=this.value,u=f.seen(),s=f.curr(),l=f.prev(),d=e.index(),c=e.bisect(e.range),h=e.bisect(r),m=h[0],v=h[1],g=c[0],p=c[1],y=e.one;if(m<g)for(t=m,a=Math.min(g,v);t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;else if(m>g)for(t=g,a=Math.min(m,p);t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;if(v>p)for(t=Math.max(m,p),a=v;t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;else if(v<p)for(t=Math.max(g,v),a=p;t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;e.range=r.slice()},d.incrementOne=function(e,r,n,i){var t,a,o,f=this.value.curr(),u=e.index(),s=e.bisect(e.range),l=e.bisect(r),d=l[0],c=l[1],h=s[0],m=s[1],v=e.one;if(d<h)for(t=d,a=Math.min(h,c);t<a;++t)f[o=u[t]]^=v,n.push(o);else if(d>h)for(t=h,a=Math.min(d,m);t<a;++t)f[o=u[t]]^=v,i.push(o);if(c>m)for(t=Math.max(d,m),a=c;t<a;++t)f[o=u[t]]^=v,n.push(o);else if(c<m)for(t=Math.max(h,c),a=m;t<a;++t)f[o=u[t]]^=v,i.push(o);e.range=r.slice()},c.Definition={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:!0,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:!0,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]},i.inherits(c,n.Transform).transform=function(e,r){var n=~(e.ignore||0),i=e.filter,t=i.mask;if(0==(t&n))return r.StopPropagation;var a=r.fork(r.ALL),o=i.data(),f=i.curr(),u=i.prev(),s=function(e){return f[e]&n?null:o[e]};return a.filter(a.MOD,s),t&t-1?(a.filter(a.ADD,(function(e){var r=f[e]&n;return!r&&r^u[e]&n?o[e]:null})),a.filter(a.REM,(function(e){var r=f[e]&n;return r&&!(r^r^u[e]&n)?o[e]:null}))):(a.filter(a.ADD,s),a.filter(a.REM,(function(e){return(f[e]&n)===t?o[e]:null}))),a.filter(a.SOURCE,(function(e){return s(e._index)}))},e.crossfilter=l,e.resolvefilter=c,Object.defineProperty(e,"__esModule",{value:!0})}));