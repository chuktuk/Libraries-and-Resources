!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-dataflow"),require("vega-scale"),require("vega-util"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scale","vega-util","d3-array","d3-interpolate"],n):n(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega,e.d3,e.d3)}(this,(function(e,n,t,a,i,r){"use strict";function o(e){n.Transform.call(this,null,e)}function l(e){n.Transform.call(this,null,e)}function s(){return n.ingest({})}function u(e){n.Transform.call(this,null,e)}function d(e){n.Transform.call(this,[],e)}a.inherits(o,n.Transform).transform=function(e,a){if(this.value&&!e.modified())return a.StopPropagation;var i=a.dataflow.locale(),r=a.fork(a.NO_SOURCE|a.NO_FIELDS),o=this.value,l=e.scale,s=null==e.count?e.values?e.values.length:10:e.count,u=t.tickCount(l,s,e.minstep),d=e.format||t.tickFormat(i,l,u,e.formatSpecifier,e.formatType,!!e.values),f=e.values?t.validTicks(l,e.values,u):t.tickValues(l,u);return o&&(r.rem=o),o=f.map((function(e,t){return n.ingest({index:t/(f.length-1||1),value:e,label:d(e)})})),e.extra&&o.length&&o.push(n.ingest({index:-1,extra:{value:o[0].value},label:""})),r.source=o,r.add=o,this.value=o,r},a.inherits(l,n.Transform).transform=function(e,t){var i=t.dataflow,r=t.fork(t.NO_SOURCE|t.NO_FIELDS),o=e.item||s,l=e.key||n.tupleid,u=this.value;return a.isArray(r.encode)&&(r.encode=null),u&&(e.modified("key")||t.modified(l))&&a.error("DataJoin does not support modified key function or fields."),u||(t=t.addAll(),this.value=u=function(e){const n=a.fastmap().test(e=>e.exit);return n.lookup=t=>n.get(e(t)),n}(l)),t.visit(t.ADD,e=>{const n=l(e);let t=u.get(n);t?t.exit?(u.empty--,r.add.push(t)):r.mod.push(t):(t=o(e),u.set(n,t),r.add.push(t)),t.datum=e,t.exit=!1}),t.visit(t.MOD,e=>{const n=l(e),t=u.get(n);t&&(t.datum=e,r.mod.push(t))}),t.visit(t.REM,e=>{const n=l(e),t=u.get(n);e!==t.datum||t.exit||(r.rem.push(t),t.exit=!0,++u.empty)}),t.changed(t.ADD_MOD)&&r.modifies("datum"),(t.clean()||e.clean&&u.empty>i.cleanThreshold)&&i.runAfter(u.clean),r},a.inherits(u,n.Transform).transform=function(e,n){var t=n.fork(n.ADD_REM),i=e.mod||!1,r=e.encoders,o=n.encode;if(a.isArray(o)){if(!t.changed()&&!o.every((function(e){return r[e]})))return n.StopPropagation;o=o[0],t.encode=null}var l="enter"===o,s=r.update||a.falsy,u=r.enter||a.falsy,d=r.exit||a.falsy,f=(o&&!l?r[o]:s)||a.falsy;if(n.changed(n.ADD)&&(n.visit(n.ADD,(function(n){u(n,e),s(n,e)})),t.modifies(u.output),t.modifies(s.output),f!==a.falsy&&f!==s&&(n.visit(n.ADD,(function(n){f(n,e)})),t.modifies(f.output))),n.changed(n.REM)&&d!==a.falsy&&(n.visit(n.REM,(function(n){d(n,e)})),t.modifies(d.output)),l||f!==a.falsy){var c=n.MOD|(e.modified()?n.REFLOW:0);l?(n.visit(c,(function(n){var a=u(n,e)||i;(f(n,e)||a)&&t.mod.push(n)})),t.mod.length&&t.modifies(u.output)):n.visit(c,(function(n){(f(n,e)||i)&&t.mod.push(n)})),t.mod.length&&t.modifies(f.output)}return t.changed()?t:n.StopPropagation},a.inherits(d,n.Transform).transform=function(e,i){if(null!=this.value&&!e.modified())return i.StopPropagation;var r,o,l,s,u,d=i.dataflow.locale(),f=i.fork(i.NO_SOURCE|i.NO_FIELDS),c=this.value,m=e.type||t.SymbolLegend,p=e.scale,h=+e.limit,g=t.tickCount(p,null==e.count?5:e.count,e.minstep),v=!!e.values||m===t.SymbolLegend,y=e.format||t.labelFormat(d,p,g,m,e.formatSpecifier,e.formatType,v),M=e.values||t.labelValues(p,g);return c&&(f.rem=c),m===t.SymbolLegend?(h&&M.length>h?(i.dataflow.warn("Symbol legend count exceeds limit, filtering items."),c=M.slice(0,h-1),u=!0):c=M,a.isFunction(l=e.size)?(e.values||0!==p(c[0])||(c=c.slice(1)),s=c.reduce((function(n,t){return Math.max(n,l(t,e))}),0)):l=a.constant(s=l||8),c=c.map((function(t,a){return n.ingest({index:a,label:y(t,a,c),value:t,offset:s,size:l(t,e)})})),u&&(u=M[c.length],c.push(n.ingest({index:c.length,label:`â€¦${M.length-c.length} entries`,value:u,offset:s,size:l(u,e)})))):m===t.GradientLegend?(r=p.domain(),o=t.scaleFraction(p,r[0],a.peek(r)),M.length<3&&!e.values&&r[0]!==a.peek(r)&&(M=[r[0],a.peek(r)]),c=M.map((function(e,t){return n.ingest({index:t,label:y(e,t,M),value:e,perc:o(e)})}))):(l=M.length-1,o=t.labelFraction(p),c=M.map((function(e,t){return n.ingest({index:t,label:y(e,t,M),value:e,perc:t?o(e):0,perc2:t===l?1:o(M[t+1])})}))),f.source=c,f.add=c,this.value=c,f};var f=a.fastmap({line:v,"line-radial":function(e,n,t,a){return v(n*Math.cos(e),n*Math.sin(e),a*Math.cos(t),a*Math.sin(t))},arc:y,"arc-radial":function(e,n,t,a){return y(n*Math.cos(e),n*Math.sin(e),a*Math.cos(t),a*Math.sin(t))},curve:M,"curve-radial":function(e,n,t,a){return M(n*Math.cos(e),n*Math.sin(e),a*Math.cos(t),a*Math.sin(t))},"orthogonal-horizontal":function(e,n,t,a){return"M"+e+","+n+"V"+a+"H"+t},"orthogonal-vertical":function(e,n,t,a){return"M"+e+","+n+"H"+t+"V"+a},"orthogonal-radial":function(e,n,t,a){var i=Math.cos(e),r=Math.sin(e),o=Math.cos(t),l=Math.sin(t),s=Math.abs(t-e)>Math.PI?t<=e:t>e;return"M"+n*i+","+n*r+"A"+n+","+n+" 0 0,"+(s?1:0)+" "+n*o+","+n*l+"L"+a*o+","+a*l},"diagonal-horizontal":function(e,n,t,a){var i=(e+t)/2;return"M"+e+","+n+"C"+i+","+n+" "+i+","+a+" "+t+","+a},"diagonal-vertical":function(e,n,t,a){var i=(n+a)/2;return"M"+e+","+n+"C"+e+","+i+" "+t+","+i+" "+t+","+a},"diagonal-radial":function(e,n,t,a){var i=Math.cos(e),r=Math.sin(e),o=Math.cos(t),l=Math.sin(t),s=(n+a)/2;return"M"+n*i+","+n*r+"C"+s*i+","+s*r+" "+s*o+","+s*l+" "+a*o+","+a*l}});function c(e){return e.source.x}function m(e){return e.source.y}function p(e){return e.target.x}function h(e){return e.target.y}function g(e){n.Transform.call(this,{},e)}function v(e,n,t,a){return"M"+e+","+n+"L"+t+","+a}function y(e,n,t,a){var i=t-e,r=a-n,o=Math.sqrt(i*i+r*r)/2;return"M"+e+","+n+"A"+o+","+o+" "+180*Math.atan2(r,i)/Math.PI+" 0 1 "+t+","+a}function M(e,n,t,a){var i=t-e,r=a-n,o=.2*(i+r),l=.2*(r-i);return"M"+e+","+n+"C"+(e+o)+","+(n+l)+" "+(t+l)+","+(a-o)+" "+t+","+a}function b(e){n.Transform.call(this,null,e)}g.Definition={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"require",type:"signal"},{name:"as",type:"string",default:"path"}]},a.inherits(g,n.Transform).transform=function(e,n){var t=e.sourceX||c,i=e.sourceY||m,r=e.targetX||p,o=e.targetY||h,l=e.as||"path",s=e.orient||"vertical",u=e.shape||"line",d=f.get(u+"-"+s)||f.get(u);return d||a.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),n.visit(n.SOURCE,(function(e){e[l]=d(t(e),i(e),r(e),o(e))})),n.reflow(e.modified()).modifies(l)},b.Definition={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},a.inherits(b,n.Transform).transform=function(e,n){var t,r,o,l=e.as||["startAngle","endAngle"],s=l[0],u=l[1],d=e.field||a.one,f=e.startAngle||0,c=null!=e.endAngle?e.endAngle:2*Math.PI,m=n.source,p=m.map(d),h=p.length,g=f,v=(c-f)/i.sum(p),y=i.range(h);for(e.sort&&y.sort((function(e,n){return p[e]-p[n]})),t=0;t<h;++t)o=p[y[t]],(r=m[y[t]])[s]=g,r[u]=g+=o*v;return this.value=p,n.reflow(e.modified()).modifies(l)};function S(e){return t.isContinuous(e)&&e!==t.Sequential}var x=a.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","domainImplicit","nice","zero","bins","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function k(e){n.Transform.call(this,null,e),this.modified(!0)}function D(e,n,i){t.isLogarithmic(e)&&(Math.abs(n.reduce((function(e,n){return e+(n<0?-1:n>0?1:0)}),0))!==n.length&&i.warn("Log scale domain includes zero: "+a.stringValue(n)));return n}function w(e,n,i){return a.isFunction(e)&&(n||i)?t.interpolateRange(e,O(n||[0,1],i)):e}function O(e,n){return n?e.slice().reverse():e}function T(e){n.Transform.call(this,null,e)}a.inherits(k,n.Transform).transform=function(e,n){var o=n.dataflow,l=this.value,s=function(e){var n,i=e.type,r="";if(i===t.Sequential)return t.Sequential+"-"+t.Linear;(function(e){const n=e.type;return t.isContinuous(n)&&n!==t.Time&&n!==t.UTC&&(e.scheme||e.range&&e.range.length&&e.range.every(a.isString))})(e)&&(n=e.rawDomain?e.rawDomain.length:e.domain?e.domain.length+ +(null!=e.domainMid):0,r=2===n?t.Sequential+"-":3===n?t.Diverging+"-":"");return(r+i||t.Linear).toLowerCase()}(e);for(s in l&&s===l.type||(this.value=l=t.scale(s)()),e)if(!x[s]){if("padding"===s&&S(l.type))continue;a.isFunction(l[s])?l[s](e[s]):o.warn("Unsupported scale property: "+s)}return function(e,n,i){var o=e.type,l=n.round||!1,s=n.range;if(null!=n.rangeStep)s=function(e,n,i){e!==t.Band&&e!==t.Point&&a.error("Only band and point scales support rangeStep.");var r=(null!=n.paddingOuter?n.paddingOuter:n.padding)||0,o=e===t.Point?1:(null!=n.paddingInner?n.paddingInner:n.padding)||0;return[0,n.rangeStep*t.bandSpace(i,o,r)]}(o,n,i);else if(n.scheme&&(s=function(e,n,i){var r,o,l=n.schemeExtent;a.isArray(n.scheme)?o=t.interpolateColors(n.scheme,n.interpolate,n.interpolateGamma):(r=n.scheme.toLowerCase(),(o=t.scheme(r))||a.error("Unrecognized scheme name: "+n.scheme));return i=e===t.Threshold?i+1:e===t.BinOrdinal?i-1:e===t.Quantile||e===t.Quantize?+n.schemeCount||5:i,t.isInterpolating(e)?w(o,l,n.reverse):a.isFunction(o)?t.quantizeInterpolator(w(o,l),i):e===t.Ordinal?o:o.slice(0,i)}(o,n,i),a.isFunction(s))){if(e.interpolator)return e.interpolator(s);a.error(`Scale type ${o} does not support interpolating color schemes.`)}if(s&&t.isInterpolating(o))return e.interpolator(t.interpolateColors(O(s,n.reverse),n.interpolate,n.interpolateGamma));s&&n.interpolate&&e.interpolate?e.interpolate(t.interpolate(n.interpolate,n.interpolateGamma)):a.isFunction(e.round)?e.round(l):a.isFunction(e.rangeRound)&&e.interpolate(l?r.interpolateRound:r.interpolate);s&&e.range(O(s,n.reverse))}(l,e,function(e,n,r){let o=n.bins;if(o&&!a.isArray(o)){let n=e.domain(),t=n[0],r=a.peek(n),l=null==o.start?t:o.start,s=null==o.stop?r:o.stop,u=o.step;u||a.error("Scale bins parameter missing step property."),l<t&&(l=u*Math.ceil(t/u)),s>r&&(s=u*Math.floor(r/u)),o=i.range(l,s+u/2,u)}o?e.bins=o:e.bins&&delete e.bins;e.type===t.BinOrdinal&&(o?n.domain||n.domainRaw||(e.domain(o),r=o.length):e.bins=e.domain());return r}(l,e,function(e,n,i){var r=function(e,n,t){return n?(e.domain(D(e.type,n,t)),n.length):-1}(e,n.domainRaw,i);if(r>-1)return r;var o,l,s=n.domain,u=e.type,d=n.zero||void 0===n.zero&&function(e){const n=e.type;return!e.bins&&(n===t.Linear||n===t.Pow||n===t.Sqrt)}(e);if(!s)return 0;S(u)&&n.padding&&s[0]!==a.peek(s)&&(s=function(e,n,i,r,o,l){var s=Math.abs(a.peek(i)-i[0]),u=s/(s-2*r),d=e===t.Log?a.zoomLog(n,null,u):e===t.Sqrt?a.zoomPow(n,null,u,.5):e===t.Pow?a.zoomPow(n,null,u,o||1):e===t.Symlog?a.zoomSymlog(n,null,u,l||1):a.zoomLinear(n,null,u);return(n=n.slice())[0]=d[0],n[n.length-1]=d[1],n}(u,s,n.range,n.padding,n.exponent,n.constant));if((d||null!=n.domainMin||null!=n.domainMax||null!=n.domainMid)&&(o=(s=s.slice()).length-1||1,d&&(s[0]>0&&(s[0]=0),s[o]<0&&(s[o]=0)),null!=n.domainMin&&(s[0]=n.domainMin),null!=n.domainMax&&(s[o]=n.domainMax),null!=n.domainMid)){const e=(l=n.domainMid)>s[o]?o+1:l<s[0]?0:o;e!==o&&i.warn("Scale domainMid exceeds domain min or max.",l),s.splice(e,0,l)}e.domain(D(u,s,i)),u===t.Ordinal&&e.unknown(n.domainImplicit?t.scaleImplicit:void 0);n.nice&&e.nice&&e.nice(!0!==n.nice&&t.tickCount(e,n.nice)||null);return s.length}(l,e,o))),n.fork(n.NO_SOURCE|n.NO_FIELDS)},a.inherits(T,n.Transform).transform=function(e,t){var a=e.modified("sort")||t.changed(t.ADD)||t.modified(e.sort.fields)||t.modified("datum");return a&&t.source.sort(n.stableCompare(e.sort)),this.modified(a),t};var A=["y0","y1"];function C(e){n.Transform.call(this,null,e)}function L(e,n,t,a,i){for(var r,o=(n-e.sum)/2,l=e.length,s=0;s<l;++s)(r=e[s])[a]=o,r[i]=o+=Math.abs(t(r))}function z(e,n,t,a,i){for(var r,o=1/e.sum,l=0,s=e.length,u=0,d=0;u<s;++u)(r=e[u])[a]=l,r[i]=l=o*(d+=Math.abs(t(r)))}function P(e,n,t,a,i){for(var r,o,l=0,s=0,u=e.length,d=0;d<u;++d)(r=+t(o=e[d]))<0?(o[a]=s,o[i]=s+=r):(o[a]=l,o[i]=l+=r)}C.Definition={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:"zero",values:["zero","center","normalize"]},{name:"as",type:"string",array:!0,length:2,default:A}]},a.inherits(C,n.Transform).transform=function(e,t){var i,r,o,l,s=e.as||A,u=s[0],d=s[1],f=n.stableCompare(e.sort),c=e.field||a.one,m="center"===e.offset?L:"normalize"===e.offset?z:P;for(i=function(e,n,t,a){var i,r,o,l,s,u,d,f,c,m=[],p=function(e){return e(s)};if(null==n)m.push(e.slice());else for(i={},r=0,o=e.length;r<o;++r)s=e[r],u=n.map(p),(d=i[u])||(i[u]=d=[],m.push(d)),d.push(s);for(u=0,c=0,l=m.length;u<l;++u){for(d=m[u],r=0,f=0,o=d.length;r<o;++r)f+=Math.abs(a(d[r]));d.sum=f,f>c&&(c=f),t&&d.sort(t)}return m.max=c,m}(t.source,e.groupby,f,c),r=0,o=i.length,l=i.max;r<o;++r)m(i[r],l,c,u,d);return t.reflow(e.modified()).modifies(s)},e.axisticks=o,e.datajoin=l,e.encode=u,e.legendentries=d,e.linkpath=g,e.pie=b,e.scale=k,e.sortitems=T,e.stack=C,Object.defineProperty(e,"__esModule",{value:!0})}));